# .github/workflows/publish-site.yml
name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      # --- SETUP STEPS ---
      - name: 2. Setup Ruby and Install Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          # bundler-cache: true is no longer needed if not using Bundler
        # If you don't use a Gemfile, you need to install Jekyll as a global gem.
        # This assumes Jekyll is the *only* Ruby gem dependency.
        run: |
          gem install jekyll
          # Also install github-pages gem if your Jekyll site uses its plugins/themes.
          # gem install github-pages

      - name: 3. Install System Dependencies (for wkhtmltopdf, etc.)
        run: |
          sudo apt update
          # ... (your existing wkhtmltopdf installation logic) ...
          sudo apt install -y fontconfig libfreetype6 libx11-6 libxext6 libxrender1 xfonts-base xfonts-75dpi xvfb
          WKHTMLTOPDF_DEB_URL="https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.bionic_amd64.deb"
          wget ${WKHTMLTOPDF_DEB_URL} -O wkhtmltox.deb
          wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb -O libssl1.1.deb
          sudo dpkg -i libssl1.1.deb || true
          sudo dpkg -i wkhtmltox.deb || sudo apt install -f -y
          rm -f wkhtmltox.deb libssl1.1.deb
          wkhtmltopdf --version

      # --- BUILD AND ARTIFACT GENERATION ---
      - name: 4. Build Jekyll Site
        # Ensure working directory is correct if Jekyll source is not at repo root
        working-directory: ${{ github.workspace }} # Assuming Jekyll command should run from repo root
        run: |
          echo "Current directory for jekyll build: $(pwd)"
          jekyll build --source ./docs --destination ./_site
          # IMPORTANT: Confirm your Jekyll project structure:
          # If your _config.yml is in './docs/' and source files are also in './docs/',
          # then you would use: jekyll build --source ./docs --destination ./_site
          # If your _config.yml is at repo root, and source files are in './docs/',
          # then you would use: jekyll build --destination ./_site (and it will automatically find ./docs as source if configured)

      - name: 5. Generate Documentation PDF
        run: |
          ./bin/assemble_docs_body.sh

      - name: 6. Move PDF into _site for Deployment
        run: |
          # This assumes Jekyll built to ./_site at the repo root
          mkdir -p _site/pdfs
          cp docs/pdfs/assembled.pdf _site/pdfs/assembled.pdf
          echo "PDF copied to _site/pdfs/assembled.pdf"

      # --- DEPLOYMENT STEP ---
      - name: 7. Deploy _site to 'output' branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: output
          commit_message: "chore(docs): Auto-deploy documentation to GitHub Pages [skip ci]"
          force_orphan: true
