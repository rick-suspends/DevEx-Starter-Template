# .github/workflows/publish-site.yml
name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      # --- SETUP STEPS ---
      - name: 2. Setup Ruby and Install Gems
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true # This still provides caching benefits

      - name: 3. Install System Dependencies (for wkhtmltopdf, etc.)
        run: |
          sudo apt update
          # ... (your existing wkhtmltopdf installation logic) ...
          sudo apt install -y fontconfig libfreetype6 libx11-6 libxext6 libxrender1 xfonts-base xfonts-75dpi xvfb
          WKHTMLTOPDF_DEB_URL="https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.bionic_amd64.deb"
          wget ${WKHTMLTOPDF_DEB_URL} -O wkhtmltox.deb
          wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb -O libssl1.1.deb
          sudo dpkg -i libssl1.1.deb || true
          sudo dpkg -i wkhtmltox.deb || sudo apt install -f -y
          rm -f wkhtmltox.deb libssl1.1.deb
          wkhtmltopdf --version

      # --- BUILD AND ARTIFACT GENERATION ---
      - name: 4. Build Jekyll Site
        # Ensure that this step is run from the repository root
        working-directory: ${{ github.workspace }}
        run: |
          echo "Current directory for bundle commands: $(pwd)" # Debugging line
          bundle install # This should now find the Gemfile at the root
          bundle exec jekyll build --source ./docs --destination ./_site
          # Note: Changed --destination to ./_site directly as per our deployment to 'output' branch
          
      # ... (rest of your workflow) ...
      - name: 5. Generate Documentation PDF
        run: |
          # This needs to run from repo root to find ./bin/assemble_docs_body.sh
          # and also needs the _site directory to be present for the HTML extraction.
          # Assuming assemble_docs_body.sh correctly outputs to docs/pdfs/assembled.pdf initially
          ./bin/assemble_docs_body.sh

      - name: 6. Move PDF into _site for Deployment
        run: |
          mkdir -p _site/pdfs # Ensure _site/pdfs exists
          cp docs/pdfs/assembled.pdf _site/pdfs/assembled.pdf
          echo "PDF copied to _site/pdfs/assembled.pdf"

      # --- DEPLOYMENT STEP ---
      - name: 7. Deploy _site to 'output' branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: output
          commit_message: "chore(docs): Auto-deploy documentation to GitHub Pages [skip ci]"
          force_orphan: true
