# .github/workflows/publish-site.yml
name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      # --- SETUP STEPS ---
      # For Ruby dependencies (like Jekyll)
      - name: 2. Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3' # Changed from '3.x' to a specific major.minor version
          bundler-cache: true

      - name: 3. Install System Dependencies (for wkhtmltopdf, etc.)
        run: |
          sudo apt update
          # Add actual wkhtmltopdf dependencies, not just a placeholder
          sudo apt install -y fontconfig libfreetype6 libx11-6 libxext6 libxrender1 xfonts-base xfonts-75dpi xvfb
          # Ensure wkhtmltopdf is installed. The 'bionic' package is often best for libssl1.1 compatibility.
          WKHTMLTOPDF_DEB_URL="https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.bionic_amd64.deb"
          wget ${WKHTMLTOPDF_DEB_URL} -O wkhtmltox.deb
          # Manually install libssl1.1 if needed for bionic build on newer Ubuntu
          wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb -O libssl1.1.deb
          sudo dpkg -i libssl1.1.deb || true
          sudo dpkg -i wkhtmltox.deb || sudo apt install -f -y
          rm -f wkhtmltox.deb libssl1.1.deb
          wkhtmltopdf --version # Verify installation


      # --- BUILD AND ARTIFACT GENERATION ---
      - name: 4. Build Jekyll Site
        run: bundle exec jekyll build

      - name: 5. Generate Documentation PDF
        run: |
          ./bin/assemble_docs_body.sh

      - name: 6. Move PDF into _site for Deployment
        run: |
          mkdir -p _site/pdfs
          cp docs/pdfs/assembled.pdf _site/pdfs/
          echo "PDF copied to _site/pdfs/assembled.pdf"

      # --- DEPLOYMENT STEP ---
      - name: 7. Deploy _site to 'output' branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: output
          commit_message: "chore(docs): Auto-deploy documentation to GitHub Pages [skip ci]"
          force_orphan: true
