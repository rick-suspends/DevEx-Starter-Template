# .github/workflows/publish-site.yml
name: Validate and Deploy Site

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write   # Needed for GitHub Pages deployment
      id-token: write # Needed for actions/deploy-pages@v4
    environment: # Required for actions/deploy-pages@v4
      name: github-pages

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        # This will include the pre-built docs/_site from your local push.
        # It also includes the 'docs/pdfs/assembled.pdf' if your local script placed it there.

      # --- Verification of docs/_site and PDF from local build ---
      - name: 1.1 Debug docs/_site and PDF contents (From Local Push)
        working-directory: ${{ github.workspace }}
        run: |
          echo "--- Debugging contents of ./docs/_site from local push ---"
          if [ ! -d "./docs/_site" ]; then
            echo "ERROR: ./docs/_site directory does NOT exist after checkout! Ensure you run 'jekyll build' locally before pushing."
            exit 1
          fi
          echo "Directory ./docs/_site exists. Listing contents:"
          ls -R ./docs/_site || { echo "ERROR: Could not list contents of ./docs/_site!"; exit 1; }
          
          echo "Checking for assembled.pdf in expected location:"
          ls -l ./docs/_site/pdfs/assembled.pdf && echo "SUCCESS: assembled.pdf found in ./docs/_site/pdfs." || echo "ERROR: assembled.pdf NOT found in ./docs/_site/pdfs! Ensure 'assemble_docs_body.sh' places it correctly locally."
          echo "--- End Debug ---"

      - name: 2. Run HTMLProofer on Pre-Built Docs
        uses: chabad360/htmlproofer@v1
        with:
          directory: ./docs/_site # Point htmlproofer to the already existing _site
          args: |
            --url-ignore "#.*"
            --url-ignore "/cdn-cgi/#.*"
            --allow-hash-href
            --disable-external
            # PDF is now expected to be in _site, so htmlproofer will check it.
            # If you want to ignore it, explicitly add it here: --file-ignore "/pdfs/assembled.pdf"
            --report-missing-names
            --check-html
            --check-favicon

      - name: 3. Install wkhtmltopdf (only if assemble_docs_body.sh needs it)
        run: |
          echo "Updating apt-get and installing wkhtmltopdf..."
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf
          echo "wkhtmltopdf installed."

      - name: 4. Generate Documentation PDF (if not already present and only if script needs wkhtmltopdf)
        working-directory: ${{ github.workspace }}
        run: |
          echo "Running assemble_docs_body.sh script..."
          # Your script is expected to place docs/pdfs/assembled.pdf into ./ci_pdfs/assembled.pdf
          ./bin/assemble_docs_body.sh 
          
          # We are assuming the script places it directly into .ci_pdfs/assembled.pdf
          # If the script output path is different, this check needs to change.
          if [ -f "./ci_pdfs/assembled.pdf" ]; then # CHECK HERE for the final location
            echo "SUCCESS: PDF file (./ci_pdfs/assembled.pdf) successfully created by assemble_docs_body.sh."
            exit 0
          else
            echo "ERROR: PDF file (./ci_pdfs/assembled.pdf) was NOT created, and assemble_docs_body.sh failed. Propagating failure."
            exit 1
          fi

      - name: 5. Setup GitHub Pages Environment
        id: pages
        uses: actions/configure-pages@v5

      - name: 6. Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs/_site' # Upload the pre-built, now PDF-included _site

      - name: 7. Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
