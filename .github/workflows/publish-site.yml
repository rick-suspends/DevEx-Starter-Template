# .github/workflows/publish-site.yml
name: Build _site and generate PDF

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2 Install wkhtmltopdf (for PDF generation)
        run: |
          echo "Updating apt-get and installing wkhtmltopdf..."
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf
          echo "wkhtmltopdf installed."

      - name: 3. Setup GitHub Pages Environment (CRITICAL FOR BASEURL)
        id: pages
        uses: actions/configure-pages@v5

      - name: 4. Build Jekyll Site with Official Action
        uses: actions/jekyll-build-pages@v1
        with:
          source: docs
          destination: docs/_site

      - name: 6. Run HTMLProofer on Pre-Processed Docs
        uses: chabad360/htmlproofer@v1
        with:
          directory: docs/_site
          args: |
            --url-ignore "#.*"
            --url-ignore "/cdn-cgi/#.*"
            --allow-hash-href
            --disable-external
            --file-ignore "/pdfs/assembled.pdf"
            --report-missing-names
            --check-html
            --check-favicon

      - name: 7. Generate Documentation PDF
        working-directory: ${{ github.workspace }}
        run: |
          echo "Running assemble_docs_body.sh script..."
          ./bin/assemble_docs_body.sh 
          
          if [ -f "docs/pdfs/assembled.pdf" ]; then
            echo "SUCCESS: PDF file (docs/pdfs/assembled.pdf) successfully created by assemble_docs_body.sh."
            exit 0
          else
            echo "ERROR: PDF file (docs/pdfs/assembled.pdf) was NOT created, and assemble_docs_body.sh failed. Propagating failure."
            exit 1
          fi

      - name: 8. Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs/_site'

      - name: 9. Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
