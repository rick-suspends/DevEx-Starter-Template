# .github/workflows/documentation-quality-gate.yml
name: Documentation Quality Gate (HTMLProofer)

on:
  push:
    branches:
      - output # Trigger this workflow ONLY when the 'output' branch is updated (i.e., after publish-site.yml deploys)
  workflow_dispatch: # Allows manual triggering from the GitHub UI

jobs:
  validate_deployed_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read # This workflow only needs to read the contents of the 'output' branch

    steps:
      # 1. CHECKOUT THE DEPLOYED CONTENT from the 'output' branch.
      # This makes the entire static site (that was pushed from docs/_site) available at the runner's root.
      - name: Checkout Deployed Site from Output Branch
        uses: actions/checkout@v4
        with:
          ref: output # IMPORTANT: Specifically checkout the 'output' branch

      # 2. RUN HTML PROOFER using the dedicated GitHub Action.
      # This action encapsulates all its dependencies and does not require Ruby/Jekyll setup.
      - name: Run HTMLProofer on Deployed Docs
        uses: chabad360/htmlproofer@v1
        with:
          # The 'directory' is the location of the HTML files to check.
          # Since we checked out the 'output' branch, the site's root is now the runner's current directory.
          directory: ./ # Target the entire root of the checked-out 'output' branch

          # 'arguments' are passed directly to the html-proofer command-line tool.
          # Customize these based on your site's specific requirements.
          arguments: '--url-ignore "#.*" --url-ignore "/cdn-cgi/#.*" --allow-hash-href --file-ignore "/pdfs/assembled.pdf" --report-missing-names --check-html --check-favicon'
          # Explanation of common arguments:
          #   --url-ignore "#.*"               : Ignores internal anchor links (e.g., #top, #section-id).
          #   --url-ignore "/cdn-cgi/#.*"      : Example: Ignores specific external patterns, if needed.
          #   --allow-hash-href                : Allows <a> tags where href is just "#".
          #   --disable-external               : Skips checking external links (faster, but misses broken external links).
          #   --file-ignore "/pdfs/assembled.pdf" : CRUCIAL: Prevents htmlproofer from trying to parse the PDF as HTML.
          #   --report-missing-names           : Reports missing 'name' attributes for anchor links.
          #   --check-html                     : Performs HTML syntax validation.
          #   --check-favicon                  : Checks for a favicon.
