# .github/workflows/documentation-quality-gate.yml
name: Documentation Quality Gate (HTMLProofer)

on:
  workflow_run: # <--- NEW TRIGGER TYPE!
    workflows: ["Build and Deploy Documentation"] # <--- Name of your publish-site.yml workflow
    types:
      - completed # Trigger when the specified workflow completes
    branches:
      - main # <--- Limit to runs of 'Build and Deploy Documentation' on the 'main' branch

  # Keep workflow_dispatch for manual runs if desired
  workflow_dispatch:

jobs:
  validate_deployed_docs:
    runs-on: ubuntu-latest
    # Grant permissions to read the repository contents.
    # This is crucial because workflow_run runs in a new context and needs explicit permissions.
    permissions:
      contents: read

    # Only run if the previous workflow (Build and Deploy) was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # The workflow_run event doesn't directly provide the 'output' branch.
      # We need to fetch the artifact from the *triggering workflow*.
      # However, for htmlproofer, it's easier to just checkout the `output` branch directly.

      # 1. CHECKOUT THE DEPLOYED CONTENT from the 'output' branch.
      # This ensures we're testing the exact content that was just deployed.
      - name: Checkout Deployed Site from Output Branch
        uses: actions/checkout@v4
        with:
          ref: output # Crucial: checkout the 'output' branch
          # token: ${{ secrets.GITHUB_TOKEN }} # Default GITHUB_TOKEN has read access, should be fine.

      # 2. RUN HTML PROOFER using the dedicated GitHub Action.
      - name: Run HTMLProofer on Deployed Docs
        uses: chabad360/htmlproofer@v1
        with:
          directory: ./ # Target the entire root of the checked-out 'output' branch
          arguments: '--url-ignore "#.*" --url-ignore "/cdn-cgi/#.*" --allow-hash-href --disable-external --file-ignore "/pdfs/assembled.pdf" --report-missing-names --check-html --check-favicon'
