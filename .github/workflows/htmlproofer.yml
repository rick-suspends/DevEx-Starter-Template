# .github/workflows/htmlproofer.yml
# This is the full content for your HTMLProofer workflow file.

name: Documentation Quality Gate (HTMLProofer) # <-- Name of THIS workflow

on:
  # This section ensures this workflow runs *AFTER* your deployment workflow completes.
  # This is crucial for htmlproofer to check the DEPLOYED content.
  workflow_run:
    # This MUST EXACTLY MATCH the 'name:' field in your 'publish-site.yml'.
    # You confirmed this is "Build _site and generate PDF".
    workflows: ["Build _site and generate PDF"] 
    types:
      - completed # Trigger when the specified workflow completes
    branches:
      - main # Trigger only if the *triggering* workflow (Build _site and generate PDF) ran on the 'main' branch

  # Add workflow_dispatch to allow manual triggering from the GitHub Actions tab for testing.
  workflow_dispatch:

jobs:
  validate_deployed_docs:
    runs-on: ubuntu-latest # Use the latest Ubuntu runner
    permissions:
      contents: read # Only needs read access to checkout the 'output' branch

    # This condition ensures the quality gate only runs if the 'Build _site and generate PDF' workflow succeeded
    # OR if it's manually dispatched (for easier debugging).
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Wait for 'output' branch to update # Give peaceiris/actions-gh-pages time to push changes
        run: |
          echo "Waiting 30 seconds for 'output' branch to fully update after deployment..."
          sleep 30
        shell: bash

      - name: Checkout Deployed Site into 'DevEx-Starter-Template' Subdirectory
        uses: actions/checkout@v4
        with:
          ref: output # Checkout the 'output' branch (which contains your deployed site)
          path: DevEx-Starter-Template # Checkout the contents into this subdirectory
        
      - name: Verify Checkout Result and Content # This step will now execute with correct YAML syntax
        run: |
          echo "--- Debugging Checkout Result and Content ---"
          echo "Current working directory on runner: $(pwd)"
          
          if [ -d "./DevEx-Starter-Template" ]; then
            echo "Directory './DevEx-Starter-Template' exists."
            echo "Contents of './DevEx-Starter-Template':"
            ls -R ./DevEx-Starter-Template || { echo "ERROR: Could not list contents of './DevEx-Starter-Template'!"; exit 1; }
            
            if [ -f "./DevEx-Starter-Template/index.html" ]; then
              echo "SUCCESS: ./DevEx-Starter-Template/index.html found."
              echo "First 25 lines of ./DevEx-Starter-Template/index.html:"
              head -n 25 ./DevEx-Starter-Template/index.html
              grep 'DevEx-Starter-Template/assets' ./DevEx-Starter-Template/index.html && \
                echo "SUCCESS: '/DevEx-Starter-Template/' prefix found in index.html (as expected before sed)." || \
                echo "WARNING: '/DevEx-Starter-Template/' prefix NOT found in index.html. Check Jekyll build baseurl or if sed already ran."
            else
              echo "ERROR: ./DevEx-Starter-Template/index.html not found. Deployment to 'output' branch might be incomplete or incorrect."
              exit 1
            fi
          else
            echo "ERROR: Directory './DevEx-Starter-Template' does NOT exist after checkout. This indicates 'actions/checkout' failed to clone the 'output' branch or the 'output' branch is empty."
            echo "Attempting to list current workspace contents to diagnose:"
            ls -al .
            exit 1
          fi
          echo "--- End Debug ---"

      - name: ðŸ’£ Pre-Process HTML: Strip Jekyll Base URL Prefix ðŸ’£
        run: |
          echo "Starting HTML pre-processing to remove Jekyll baseurl prefix from internal links..."
          find ./DevEx-Starter-Template -type f -name "*.html" -print0 | xargs -0 \
            sed -i 's/\/DevEx-Starter-Template\//\//g'
          echo "HTML path rewrite complete. Verifying changes on sample file..."
          
          grep 'DevEx-Starter-Template/assets' ./DevEx-Starter-Template/index.html && \
            echo "ERROR: The '/DevEx-Starter-Template/' prefix was NOT successfully stripped by sed. Sed command failed." || \
            echo "SUCCESS: '/DevEx-Starter-Template/' prefix stripped from sample file. Proceeding to HTML-Proofer."
          echo "--- End Pre-processing ---"

      - name: âš™ï¸ Run HTMLProofer on Pre-Processed Docs
        uses: chabad360/htmlproofer@v1
        with:
          directory: ./DevEx-Starter-Template 
          args: >-
            --url-ignore "#.*"
            --url-ignore "/cdn-cgi/#.*"
            --allow-hash-href
            --disable-external
            --file-ignore "/pdfs/assembled.pdf"
            --report-missing-names
            --check-html
            --check-favicon
