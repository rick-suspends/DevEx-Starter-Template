# .github/workflows/documentation-quality-gate.yml
name: Documentation Quality Gate (HTMLProofer)

on:
  workflow_run:
    workflows: ["Build and Deploy Documentation"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  validate_deployed_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Deployed Site into 'DevEx-Starter-Template' Subdirectory
        uses: actions/checkout@v4
        with:
          ref: output
          path: DevEx-Starter-Template # <--- CRITICAL CHANGE: Checkout into this path

      - name: Debug Checkout Path (Optional, but good for verification)
        run: |
          echo "Current working directory: $(pwd)"
          echo "Contents of the checked-out directory 'DevEx-Starter-Template':"
          ls -R ./DevEx-Starter-Template || { echo "ERROR: DevEx-Starter-Template directory not found or empty!"; exit 1; }
          echo "Sample HTML content (first few lines of index.html):"
          head -n 20 ./DevEx-Starter-Template/index.html | grep "DevEx-Starter-Template" || echo "No DevEx-Starter-Template prefix found in index.html, check config."
          
      - name: Run HTMLProofer on Top-Level Deployed Docs
        uses: chabad360/htmlproofer@v1
        with:
          # --- Point directory to the checked-out content's root ---
          directory: ./DevEx-Starter-Template # <--- htmlproofer's base is now the content's root
          args: >-
            --url-ignore "#.*"
            --url-ignore "/cdn-cgi/#.*"
            --allow-hash-href
            --disable-external
            --file-ignore "/pdfs/assembled.pdf"
            --report-missing-names
            --check-html
            --check-favicon
            # --- NO --root_dir or --swap_urls should be needed here! ---
            # If the HTML links are /DevEx-Starter-Template/assets/...
            # and the content is checked out to ./DevEx-Starter-Template
            # and htmlproofer's directory is ./DevEx-Starter-Template,
            # then it should resolve those paths correctly without further transforms.
