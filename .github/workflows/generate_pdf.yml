name: Generate Documentation PDF

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_pdf:
    runs-on: ubuntu-latest
    
    # NEW: Define a Docker container for this job
    container:
      image: alpine/wkhtmltopdf:0.12.6-full # Using a reliable image with wkhtmltopdf and dependencies
      options: --user root # Run as root inside the container for permissions if needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # Since we are in a container, the host's apt is not used.
      # The wkhtmltopdf image should already have all necessary fonts and xvfb.

      # We need to install 'wget' and 'git' *inside* the container if they are not present,
      # as we will need them for the script and pushing changes.
      # The alpine/wkhtmltopdf:0.12.6-full image should have wget, but git might need installing.
      - name: Install Git inside container (if not present)
        run: |
          apk update && apk add git # Alpine's package manager is 'apk'
        # This step might not be strictly necessary if the base image includes git,
        # but it's good for robustness.
      
      - name: Create pdfs directory (container might not have it pre-made)
        run: mkdir -p docs/pdfs

      - name: Run PDF assembly script
        run: |
          chmod +x ./bin/assemble_docs_body.sh
          # Important: Python is likely not installed by default in this Alpine image.
          # You'll need to install it if your assemble_docs_body.sh relies on a Python HTTP server.
          # For Alpine, it would be 'apk add python3'.
          # If your script requires Python, add 'apk add python3' here before running it.
          # If your script doesn't use Python or its HTTP server, ignore this.
          
          # Assuming python is needed for the HTTP server based on previous logs:
          apk add python3
          
          ./bin/assemble_docs_body.sh
        working-directory: ${{ github.workspace }}

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: assembled-documentation-pdf
          path: docs/pdfs/assembled.pdf

      - name: Commit and push generated PDF to repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        # This step runs on the *host* runner, not inside the container,
        # as the container exits after the job. This is necessary to access Git capabilities outside the container.
        # So we need to ensure git is on the host runner, which it always is.
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/pdfs/assembled.pdf
          git diff --quiet --exit-code || git commit -m " chore(docs): Update assembled documentation PDF [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
