name: Generate Documentation PDF

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_pdf:
    runs-on: ubuntu-latest
    
    container:
      image: madnight/docker-wkhtmltopdf:0.12.6-alpine # CORRECTED IMAGE TAG
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # For Alpine-based images, 'apk' is the package manager.
      # It usually comes with Git, but installing Python3 might still be needed.
      - name: Install Python3 inside container (if not present)
        run: |
          apk update && apk add python3 # Use 'apk' for Alpine-based images
      
      - name: Create pdfs directory (container might not have it pre-made)
        run: mkdir -p docs/pdfs

      - name: Run PDF assembly script
        run: |
          ./bin/assemble_docs_body.sh
        working-directory: ${{ github.workspace }}

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: assembled-documentation-pdf
          path: docs/pdfs/assembled.pdf

      - name: Commit and push generated PDF to repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/pdfs/assembled.pdf
          git diff --quiet --exit-code || git commit -m " chore(docs): Update assembled documentation PDF [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
