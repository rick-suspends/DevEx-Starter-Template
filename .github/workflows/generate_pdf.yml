name: Generate Documentation PDF

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # NEW STEP: Use a dedicated GitHub Action for wkhtmltopdf installation
      - name: Install wkhtmltopdf and xvfb via action
        uses: wkhtmltopdf/wkhtmltopdf-action@v1.0.0 # Use the official action
        with:
          wkhtmltopdf_version: "0.12.6" # Specify a stable version
          install_xvfb: true # Request XVFB to be installed by the action
        # The action handles apt update and dependencies internally for wkhtmltopdf and xvfb

      # Original dependencies for good measure, though the action might cover some
      # (Removed apt update as the action should handle it, added fontconfig explicitly)
      - name: Install additional system fonts (if needed, otherwise remove)
        run: |
          sudo apt install -y fontconfig xfonts-base xfonts-75dpi
        # This step can be removed if wkhtmltopdf works without it.

      - name: Run PDF assembly script
        run: |
          chmod +x ./bin/assemble_docs_body.sh
          ./bin/assemble_docs_body.sh
        working-directory: ${{ github.workspace }}

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: assembled-documentation-pdf
          path: docs/pdfs/assembled.pdf

      - name: Commit and push generated PDF to repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/pdfs/assembled.pdf
          git diff --quiet --exit-code || git commit -m " chore(docs): Update assembled documentation PDF [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
